var e="http://www.farmastampati.mobi/FarmastampatiMobi";var a="http://127.0.0.1:60510";var t=e;var r=1e3;var i=1e3;var n="prezzo discrezionale";var o=t+"/query";var s={dati:null,nascondiPrezzoND:false,nascondiRimborsoND:false,encoding:"base64",ricercaIniziale:"",query:null};var l={data:[""],index:[""],put:function(e,a){for(var t=1;this.data.length>1&&t<this.data.length;t+=2){if(this.data[t]==e){this.data[t+1]=a;return}}this.data[this.data.length]=e;this.data[this.data.length]=a},get:function(e){for(var a=1;this.data.length>1&&a<this.data.length;a+=2){if(this.data[a]==e){return this.data[a+1]}}return null},remove:function(e){for(var a=1;this.data.length>1&&a<this.data.length;a+=2){if(this.data[a]==e){for(j=a;j<this.data.length-2;j+=2){this.data[j]=this.data[j+2];this.data[j+1]=this.data[j+3]}this.data=this.data.slice(0,this.data.length-2);return}}},contains:function(e){return this.get(e)!=null},length:function(){return this.data.length>1?(this.data.length-1)/2:0},sort:function(){for(var e=1;this.data.length>1&&e<this.data.length;e+=2){this.index[(e-1)/2]=this.data[e]}this.index.sort(function(e,a){var t=e.split(" ");var r=a.split(" ");t[0]=t[0].replace(/\,/g,".");r[0]=r[0].replace(/\,/g,".");if(!isNaN(t[0])&&!isNaN(r[0])){var i=100*parseFloat(t[0]);i-=100*parseFloat(r[0]);return i}else{var i=0;for(var n=0;n<a.length&&n<e.length;n++){i=e.charCodeAt(n)-a.charCodeAt(n);if(i!=0)return i}}return e.length-a.length})},getSortedKey:function(e){return this.index[e]},getSortedValue:function(e){return this.get(this.index[e])},clear:function(){this.data=[""];this.index=[""]},toString:function(){return JSON.stringify(this.data)}};function msgbox(e,a,t){if(t){setTimeout("msgbox ('"+e+"', '"+a+"')",t);return}var r=$.mobile.activePage.attr("id");if(r=="search"){r=""}try{$("#popupDialog"+r+"Title").html(a?a:"Avviso");$("#popupDialog"+r+"Message").html(e);$("#popupDialog"+r).popup("open",{allowSamePageTransition:true,transition:"pop"})}catch(i){alert(i)}}function c(e){try{if(!e||e.length==0)return n;if(e.indexOf("0.00")==0)return n;if(e.indexOf("99999")==0)return n;var a=e.indexOf(".")<0?",":".";var t=e.split(a);if(t&&t.length>0){e=t[0];e+=a;e+=t[1].length>2?t[1].substr(0,2):t[1]}return"&euro; "+e}catch(r){return n}}function u(e,a){var t="";if(!a)a="'";for(var r=0;e!=null&&r<e.length;r++){var i=e.charAt(r);if(i==a)t+="\\";t+=i}return t}function f(e){var a=e.replace(/gtt /i,"gocce ").replace(/bust /i,"bustine ").replace(/polv /i,"polvere ").replace(/cpr /i,"compresse ").replace(/cps /i,"capsule ").replace(/grat /i,"granulato ").replace(/ riv/i," rivestite").replace(/ mast/i," masticabili").replace(/ eff/i," effervescenti").replace(/\*/g,"<br/>");var t=a.indexOf("(");var r=a.indexOf(")");if(t>0&&r>0&&t<r){a=a.substr(0,t).trim()+a.substr(r+1).trim()}return a}function d(e){if(e==null)return"";return e.toUpperCase()}function h(e){var a=e.split(" ");var t=0;var r=0;for(t=0;t<a.length;t++){if(!isNaN(a[t]))r++;if(r==2)break}var i="";for(var n=0;n<t;n++){i+=a[n];i+=" "}return i}function g(e,a){var t=0;var r=e.replace(/\?/gi,function o(e){if(t>a.length||typeof a[t]=="undefined")return e;var r=a[t++];if(r.indexOf&&r.indexOf("text:")==0){r="'"+u(r.substring(5,r.length),"'")+"'"}return r});console.log("SQL > "+r);switch(s.encoding){case"base64":return Base64.encode(r);case"xor":var i="";for(var n=0;n<a.length;n++){if(i.length>0)i+=";";i+=a[n]}return{data:r,params:i};default:return r}}function p(){var e="";var a=d(s.formaSelezionata).toUpperCase();$("#resultsHeader").html("");$("#resultsList").empty();e+='<ul data-role="listview" data-autodividers="false" data-inset="true">';e+='<li data-role="list-divider" style="color: #808080; height: 50px;">';e+='<span class="x-scrolling">';e+="ELENCO DEI FARMACI EQUIVALENTI<br/>";e+=s.ricercaIniziale+"<br>";var t="";for(var r=0;r<H.length;r++){if(!H||!H[r]||H[r].length==0)continue;if(t.length>0)t+=" &gt; ";t+=H[r]}e+=t;e+="</span>";e+="</li>";var i=0;var o=s.dati;var l="";for(var r=0;o!=null&&r<o.length;r++){var u=o[r];var h=f(u.descrizione);var g=c(u.prezzoAlPubblico);var p=c(u.prezzoRimborsoNazionale);if(g==n&&s.nascondiPrezzoND)continue;if(p==n&&s.nascondiRimborsoND)continue;var v="[["+u.descrizione+","+u.ditta+"]]";if(l.indexOf(v)>=0)continue;l+=v;if(u.descrizione.indexOf(H[V])<0){console.log("ignora posologia non selezionata ("+H[V-2]+"): "+u.descrizione);continue}var m=u.brand!="S"?"color: darkGreen;":"color: red;";e+='<li data-role="list-divider" style="background: white">';e+='<span class="x-scrolling" style=" '+m+'">';e+=h;e+='<br/><span style="font-size: smaller;">';e+=u.ditta;e+="</span>";if(u.classe=="CN")u.classe="C";if(g!=n){e+="<br/>Prezzo "+(u.classe=="C"?"massimo":"")+' <span color="'+(g==n?"darkRed":"darkBlue")+'">';e+=g;e+="</span>"}else{e+="<br/><i>Prezzo discrezionale</i>"}if(u.tipoRicetta&&u.classe=="C"&&(u.tipoRicetta!="C"&&u.tipoRicetta!="D"&&u.tipoRicetta!="h")){e+="<br/><b>Con obbligo di ricetta</b>"}if(p!=n){var S=parseFloat(u.prezzoAlPubblico);S-=parseFloat(u.prezzoRimborsoNazionale);S*=100;S=Math.round(S);var E=""+S;var I=E.substr(0,E.length-2);if(I.length==0)I="0";var b=E.substr(E.length-2,E.length);if(u.classe=="C"){e+="<br/><b><u>Costo a carico del cittadino</u></b>"}else if(u.classe=="A"){e+="<br/><b>Costo a carico del cittadino "+I+(b!="0"&&b!="00"?"."+b:"")+" &euro;</b>"}}if(u.inListaDiTrasparenza=="CN"){e+='&nbsp;<img src="images/inlista.png" style="border: 0px; width: 16px;" ';e+='alt="in lista di trasparenza"/>&nbsp;in lista di trasparenza'}e+="<br/><span>Classe "+u.classe+"</span>";e+="</span>";e+="</li>";i++}$("#resultsList").append(e);$("#resultsList ul").each(function(e){$(this).listview().listview("refresh")});return i}function v(e){$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:M(J!=null?"cercaDettagli":"cercaDettagliSenzaUPS",J!=null?[i,e,J]:[i,e]),encoding:s.encoding},method:"POST",success:function(e){s.dati=e;if(p()<=0){$("#resultsHeader").html($("#resultsHeader").html()+'<br><br><b style="color: red; font-weight: bolder;">IL FARMACO NON HA EQUIVALENTI</b>')}$.mobile.changePage("#results",{allowSamePageTransition:true,transition:"slide"})},error:function(e){msgbox("La ricerca della lista dei farmaci ha causato un errore","Avviso",200)}})}function m(e,a,t){var r=0;var i="0123456789BCDFGHJKLMNPQRSTUVWXYZ";for(var n=e.length-1;n>=0;n--){var o=i.indexOf(e.substr(n,1));r+=o*Math.pow(32,e.length-(n+1))}var s=""+r;if(a&&a>0){while(s.length<a){s="0"+s}}return t?t+s:s}function S(){$("#resultsList").html("");if(typeof cordova=="undefined"){msgbox("Funzione non disponibile in questa versione");return}cordova.plugins.barcodeScanner.scan(function(e){if(e.cancelled){return}if(e.format=="CODE_39"){var a=m(e.text,9);if(a.indexOf("A")>=0)a=a.substr(1);J=null;w(a)}else{msgbox("Il codice a barre non &egrave; valido<br/>provare con un altro codice a barre riportato sulla scatola")}},function(e){msgbox("Scansione fallita<br/>codice di errore:"+e)})}function OnClickAutocomplete(e,a,t){$(t).html("");$(t).listview("refresh");$(t).listview().listview("refresh");if(t=="#autocomplete1"){$("#autocomplete2div").hide()}else if(t=="#autocomplete2"){$("#autocomplete1div").hide()}E=t;$("#search").find("input").val(e);var r=I();s.ricercaIniziale=r;if(H){for(var i=0;i<H.length;i++){H[i]=""}}switch(a){case"A":L(r);break;case"B":N(r);break;case"C":U("tabellaOrdinataDosaggiPerPA",r);break;case"D":U("tabellaOrdinataDosaggiPerNF",r);break;default:console.log("ERROR: OnClickAutocomplete invoked with invalid type: "+a);break}}var E=null;function I(){var e="";var a=0;$("#search .ui-input-search").find("input").each(function(a){e=$(this).val()});return e}function b(e,a){var t="";$("#search .ui-input-search "+a).find("input").each(function(a){$(this).textinput(e?"enable":"disable")});return t}function O(){$("#search .ui-input-search").find("input").each(function(e){$(this).val("")})}function OnClickForma(e,a){var t="";l.clear();if(selectionMap_!=null){var r=y(e);for(var i=0;i<r.dosaggi.length;i++){if(r.dosaggi[i].dosaggio==null)continue;if(r.dosaggi[i].dosaggio.length==0)continue;var n=T(r.dosaggi[i].dosaggio);if(l.contains(n))continue;l.put(n,r.dosaggi[i].dosaggio)}l.sort();for(var i=0;i<l.length();i++){t+='<tr><td align="left">';t+="<a href=\"javascript: OnClickDosaggio('"+e+"', '"+l.getSortedValue(i)+"')\" ";t+='class="ui-corner-all ui-shadow ui-overlay-shadow ui-btn" ';t+='style="background: #11389D; color: white; font-weight: bolder; border-radius: 16px !important;">';t+='<span class="ui-btn-inner" style="vertical-align: middle;">';t+='<span class="ui-btn-text">'+l.getSortedKey(i)+"</span>";t+="</span>";t+="</a>";t+="</td></tr>"}}else{var r=a.split("|");for(var i=0;i<r.length;i++){if(r[i].length==0)continue;var n=T(r[i]);if(l.contains(n))continue;l.put(n,r[i])}l.sort();for(var i=0;i<l.length();i++){t+='<tr><td align="left">';t+="<a href=\"javascript: OnClickDosaggio('"+e+"', '"+l.getSortedValue(i)+"')\" ";t+='class="ui-corner-all ui-shadow ui-overlay-shadow ui-btn" ';t+='style="background: #11389D; color: white; font-weight: bolder; border-radius: 16px !important;">';t+='<span class="ui-btn-inner" style="vertical-align: middle;">';t+='<span class="ui-btn-text">'+l.getSortedKey(i)+"</span>";t+="</span>";t+="</a>";t+="</td></tr>"}}$("#cerca0").html("selezionare dosaggio");$("#menuforma").html(t);$.mobile.changePage("#search",{allowSamePageTransition:true,transition:"slide"})}function OnClickDosaggio(e,a){s.formaSelezionata=e;s.dosaggioSelezionato=T(a);var t="";if(selectionMap_!=null){t=M("cercaGruppoPerDescrizioneEstesa",["text:"+I()+"%"+a.trim()+"%"])}else{t=M("cercaGruppoPerPrincipioAttivo",["text:"+I(),"text:%"+a.trim()+"%"])}$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:t,encoding:s.encoding},method:"POST",success:function(e){if(!e||e.length<=0){msgbox("Non esistono farmaci equivalenti<br/>al prodotto selezionato:<br/>"+s.ricercaIniziale,"Avviso",200);return}var a=null;var t="";for(var r=0;r<e.length;r++){if(!a&&e[r].aic)a=e[r].aic;switch(e[r].classe){case"A":case"H":if(e[r].codeA){if(t.length>0)t+=" OR ";t+="APP_CA.FDI_1010 = '"+e[r].codeA+"'"}break;case"C":case"CN":if(e[r].codeC){if(t.length>0)t+=" OR ";t+="APP_CA.FDI_1094 = '"+e[r].codeC+"'"}break;case"GR":if(e[r].codeGR){if(t.length>0)t+=" OR ";t+="TR041.FDI_T507 = '"+e[r].codeGR+"'"}break;default:console.log("warning: trovata classe non valida: "+e[r].classe)}}if(t.length==0){if(!s.isPA){t="APP_CA.FDI_4875 like '"+I()+"%'"}else{t="APP_CA.FDI_0001 = '"+a+"'"}}v(t)},error:function(e){msgbox("La ricerca dei farmaci equivalenti ha causato un errore:<br/>"+e)}})}function R(e){var a=e.toUpperCase();for(var t=0;t<forma_f_.length;t+=2){if(a.indexOf(forma_f_[t])>=0){var r=a.indexOf(forma_f_[t]);var i=forma_f_[t].length;r+=i;var n=e.substring(r).trim().split(" ");var o="";for(var s=0;s<n.length;s++){if(o.length==0&&isNaN(n[s]))continue;o+=" ";o+=n[s]}return o.replace(/ con/i,"")}}return""}function C(e){var a="";var t=e.split(" ");for(var r=t.length-1;r>=0;r--){if(!isNaN(t[r])&&r==t.length-1)continue;a=t[r]+" "+a;if(!isNaN(t[r])){break}}t=a.split(" ");a="";for(var i=0;i<t.length&&i<3;i++){a+=t[i];a+=" "}return a}function P(e){var a=0;var t="";var r=e.split(" ");var i=false;for(var n=0;n<r.length;n++){if(a==3&&t.length>0)break;var o=r[n].replace(/\,/g,".").toUpperCase();if(n==0&&!isNaN(o))continue;if(r[n]=="+"&&i){t+=" +";i=false;a=0}else if(!isNaN(o)){t+=" ";t+=r[n];i=false;a=0}else if(o.indexOf("CPR")>=0||o.indexOf("CPS")>=0||o.indexOf("BUST")>=0||o.indexOf("GRAT")>=0||o.indexOf("BOMB")>=0){t="";i=true;a=0}else{if(t.length>0){t+=" ";t+=r[n]}i=true}a++}if(t.trim().length==0)return e;var s=t.trim();return s.replace(/litro litri/i,"litri").replace(/litri litri/i,"litri").replace(/litri \(litri/i,"litri").replace(/litri con/i,"litri").replace(/ con/i,"")}var T=P;function A(e){return e}function w(e){var a="";if(e.indexOf(",")>0){var t=e.split(",");var r="";for(var i=0;i<t.length;i++){if(!t[i])continue;if(t[i].length==0)continue;if(r.length>0)r+=", ";r+="'"+t[i]+"'"}a=M("cercaGruppoPerAIC_in",[r])}else{a=M("cercaGruppoPerAIC",["text:"+e])}$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:a,encoding:s.encoding},method:"POST",success:function(e){if(!e||e.length<=0){msgbox("Codice farmaco non trovato","Avviso",200);return}var a="";for(var t=0;t<e.length;t++){s.formaSelezionata=e[t].dosaggio;dosaggioSelezionato="";switch(e[t].classe){case"A":case"H":if(a.length>0)a+=" OR ";a+="APP_CA.FDI_1010 = '"+e[t].codeA+"'";break;case"C":case"CN":if(a.length>0)a+=" OR ";a+="APP_CA.FDI_1094 = '"+e[t].codeC+"'";break;default:console.log("warning: trovata classe non valida: "+e[t].classe)}if(Q!=2)break}if(a.length==0){msgbox("Il prodotto non ha farmaci equivalenti","Avviso",200);console.log("la ricerca non ha prodotto gruppi di equivalenza validi");return}v(a)},error:function(e){msgbox("La ricerca dei farmaci equivalenti ha causato un errore:<br/>"+e)}})}var selectionMap_=null;function y(e,a){for(var t=0;t<selectionMap_.length;t++){if(e==selectionMap_[t].forma){if(a){var r=selectionMap_[t].dosaggi;for(var i=0;i<r.length;i++){if(r[i].dosaggio==a){return r[i]}}return null}else{return selectionMap_[t]}}}return null}function x(e){switch(e.toUpperCase()){case"COMPRESSE DELITESCENTI":case"COMPRESSE DISPERSIBILI":case"COMPRESSE DIVISIBILI":case"COMPRESSE DIVISIBILI RM":case"COMPRESSE DIVISIBILI RP":case"COMPRESSE DIVISIBILI RILASCIO MODIFICATO":case"COMPRESSE DIVISIBILI RILASCIO PROLUNGATO":case"COMPRESSE EFFERVESCENTI SOLUB":case"COMPRESSE EFFERVESCENTI SOLUB.":case"COMPRESSE EFFERVESCENTI SOLUBILI":case"COMPRESSE GASTRORESISTENTI":case"COMPRESSE GASTRORESISTENTI RM":case"COMPRESSE GASTRORESISTENTI RP":case"COMPRESSE GASTRORESISTENTI RILASCIO MODIFICATO":case"COMPRESSE GASTRORESISTENTI RILASCIO PROLUNGATO":case"COMPRESSE MUCOADESIVE":case"COMPRESSE ORODISPERSIBILI":case"COMPRESSE ORODISPERS/SUBLING":case"COMPRESSE ORODISPERS./SUBLING.":case"COMPRESSE ORODISPERSIBILI/COMPRESSE SUBLINGUALI":case"COMPRESSE RC":case"COMPRESSE RILASCIO CONTROLLATO":case"COMPRESSE RIVESTITE":case"COMPRESSE RIVESTITE DIVISIBILI":case"COMPRESSE RIVESTITE GASTRORES":case"COMPRESSE RIVESTITE GASTRORESISTENTI":case"COMPRESSE RIVESTITE MASTICAB":case"COMPRESSE RIVESTITE MASTICABILI":case"COMPRESSE RIVESTITE RM":case"COMPRESSE RIVESTITE RP":case"COMPRESSE RIVESTITE RILASCIO MODIFICATO":case"COMPRESSE RIVESTITE RILASCIO PROLUNGATO":case"COMPRESSE RM":case"COMPRESSE RILASCIO MODIFICATO":case"COMPRESSE RP":case"COMPRESSE RILASCIO PROLUNGATO":case"COMPRESSE SOLUBILI":case"COMPRESSE SOLUB E MASTICABILI":case"COMPRESSE SOLUBILI E MASTICABILI":case"COMPRESSE SOLUZIONE CUTANEA":case"COMPRESSE PER SOLUZIONE CUTANEA":case"COMPRESSE SUBLINGUALI":return"COMPRESSE";case"COMPRESSE RIVESTITE MASTICAB":case"COMPRESSE RIVESTITE MASTICABILI":return"COMPRESSE MASTICABILI"}return e}function N(e){if(e.length==0){msgbox("Inserire il nome del farmaco");return}s.isPA=false;$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:M("cercaPerDescrizioneEstesa",["text:"+e+"%"]),encoding:s.encoding},method:"POST",success:function(e){if(!e||e.length<=0){msgbox("Il farmaco "+I()+"<br/>non ha equivalenti associati","Avviso",200);return}$("#cerca0").html("selezionare tipologia");$("#menucerca").hide();$("#menuforma").hide();var a="";savedHtml="";selectionMap_=[""];for(var t=0;t<e.length;t++){e[t].forma=x(e[t].forma);var r=[e[t].forma,e[t].dx];var i=y(r[0]);if(!i){i={forma:r[0],dosaggi:[{dosaggio:r[1],aic:[e[t].aic]}]};selectionMap_[selectionMap_.length]=i}var n=y(r[0],r[1]);if(!n){n={dosaggio:r[1],aic:[""]};i.dosaggi[i.dosaggi.length]=n}n.aic[n.aic.length]=e[t].aic}for(var o=0;o<selectionMap_.length;o++){if(!selectionMap_[o].forma)continue;if(selectionMap_[o].forma.length==0)continue;a+='<tr><td align="left">';a+="<a href=\"javascript: OnClickForma('"+selectionMap_[o].forma+"')\" ";a+='class="ui-corner-all ui-shadow ui-overlay-shadow ui-btn" ';a+='style="background: #11389D; color: white; font-weight: bolder; border-radius: 16px !important; word-wrap: break-word;">';a+='<span class="ui-btn-inner" style="vertical-align: middle;">';a+='<span class="ui-btn-text" style="font-size: 14px;">';a+=d(selectionMap_[o].forma);a+="</span>";a+="</span>";a+="</a>";a+="</td></tr>"}$("#menuforma").html(a);$("#menuforma").slideToggle("slow",function(){});$.mobile.changePage("#search",{allowSamePageTransition:true,transition:"slide"})},error:function(e){msgbox("La ricerca per principio attivo ha causato un errore:<br/>"+e)}})}function M(e,a){var t=null;s.query.find("query").each(function(){var a=$(this).attr("name");if(a.toLowerCase().trim()==e.toLowerCase().trim()){return $(this).find("sql").each(function(){t={sql:$(this).text().trim(),encoding:$(this).attr("encoding")}})}});return g(t.sql,a)}function L(e){if(e.length==0){msgbox("Inserire il nome del principio attivo");return}s.isPA=true;selectionMap_=null;$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:M("cercaPerPrincipioAttivo",["text:"+e]),encoding:s.encoding},method:"POST",success:function(e){if(!e||e.length<=0){msgbox("Nessun farmaco autorizzato in<br/>classe A o C","Avviso",200);return}$("#cerca0").html("selezionare tipologia");$("#menucerca").hide();$("#menuforma").hide();var a="";savedHtml="";var t=0;var r=[""];for(var i=0;i<e.length;i++){var n=e[i].dx.split("*");n[0]=x(d(n[0]));var o=false;for(var s=0;s<t;s+=2){if(n[0]==r[s]){var l=r[s+1];if(l.indexOf("|"+n[1]+"|")<0){r[s+1]+=n[1];r[s+1]+="|"}o=true;break}}if(!o){t+=2;r[t-2]=n[0];r[t-1]=n[1];r[t-1]+="|"}}var c=A(r);for(var s=0;s<t;s+=2){var f=c[s];a+='<tr><td align="left">';a+="<a href=\"javascript: OnClickForma('"+c[s]+"', '"+u(c[s+1],"'")+"')\" ";a+='class="ui-corner-all ui-shadow ui-overlay-shadow ui-btn" ';a+='style="background: #11389D; color: white; font-weight: bolder; border-radius: 16px !important;">';a+='<span class="ui-btn-inner" style="vertical-align: middle;">';a+='<span class="ui-btn-text" style="font-size: 14px;">'+f+"</span>";a+="</span>";a+="</a>";a+="</td></tr>"}$("#menuforma").html(a);$("#menuforma").slideToggle("slow",function(){});$.mobile.changePage("#search",{allowSamePageTransition:true,transition:"slide"})},error:function(e){msgbox("La ricerca per principio attivo ha causato un errore:<br/>"+e)}})}function D(){window.location.hash="no-back-button";window.location.hash="Again-No-back-button";window.onhashchange=function(){window.location.hash="no-back-button";console.log("override window location ... stage:: "+K)};$("#cerca3").on("click",function(){S()});$("#resultsMenu :input").change(function(){switch(this.name){case"choice-1":s.nascondiPrezzoND=this.checked;p();break;case"choice-2":s.nascondiRimborsoND=this.checked;p();break}});$("#searchclickProducts").on("click",function(){$("#cerca0").html("");$("#menuforma").hide();$("#menucerca").hide();$("#menucerca").slideToggle("slow",function(){});setTimeout(function(){$.mobile.changePage("#search",{reverse:true,allowSamePageTransition:true,transition:"slide"})},200)});$("#searchclick").on("click",function(){$("#menuforma").hide();$("#menucerca").hide();$("#menucerca").slideToggle("slow",function(){});O();$("#autocomplete1div").show();$("#autocomplete2div").show();$("#cerca0").html("");setTimeout(function(){$.mobile.changePage("#search",{reverse:true,allowSamePageTransition:true,transition:"slide"})},200)});if(typeof cordova=="undefined"){}$("#autocomplete1").on("filterablebeforefilter",function(e,a){var t=$(this),i=$(a.input),n=i.val(),l="";t.html("");if(n&&n.length>2){t.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>");t.listview("refresh");var c="";var u=n.split(" ");for(var f=0;f<u.length;f++){var d=u[f];if(d.length==0)continue;c+=c.length>0?"%"+d:d}var h=c;if(c.length<=2)return;var g=M("autocompletaPrincipioAttivo",[r,"text:"+c+"%"]);$.ajax({url:o,dataType:"jsonp",crossDomain:true,data:{sql:g,encoding:s.encoding}}).then(function(e){var a="|";$.each(e,function(e,t){var r=null;var i=t.split("|");if(i[0]=="A"||i[0]=="C"){r=i[1];if(a.indexOf("|"+r+"|")>=0)return;a+=r+"|";r='<span style="color: #007700;">'+r+"</span>"}else if(i[0]=="B"||i[0]=="D"){r=i[1].replace(/\(/gi,'<i style="font-size: smaller;">').replace(/\)/gi,"</i>");if(a.indexOf("|"+r+"|")>=0)return;a+=r+"|";r='<span style="color: #000077;">'+r+"</span>"}l+="<li><a href=\"javascript:OnClickAutocomplete('"+i[1]+"', '"+i[0]+"', '#autocomplete1')\">"+r+"</a></li>"});t.html(l);t.listview("refresh");t.trigger("updatelayout")})}});$("#autocomplete2").on("filterablebeforefilter",function(e,a){var t=$(this),i=$(a.input),n=i.val(),l="";t.html("");if(n&&n.length>2){t.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>");t.listview("refresh");var c="";var u=n.split(" ");for(var f=0;f<u.length;f++){var d=u[f];if(d.length==0)continue;c+=c.length>0?"%"+d:d}var h=c;if(c.length<=2)return;var g=M("autocompletaNomeFarmaco",[r,"text:"+h+"%"]);$.ajax({url:o,dataType:"jsonp",crossDomain:true,data:{sql:g,encoding:s.encoding}}).then(function(e){var a="|";$.each(e,function(e,t){var r=null;var i=t.split("|");if(i[0]=="A"||i[0]=="C"){r=i[1];if(a.indexOf("|"+r+"|")>=0)return;a+=r+"|";r='<span style="color: #007700;">'+r+"</span>"}else if(i[0]=="B"||i[0]=="D"){r=i[1].replace(/\(/gi,'<i style="font-size: smaller;">').replace(/\)/gi,"</i>");if(a.indexOf("|"+r+"|")>=0)return;a+=r+"|";r='<span style="color: #000077;">'+r+"</span>"}l+="<li><a href=\"javascript:OnClickAutocomplete('"+i[1]+"', '"+i[0]+"', '#autocomplete2')\">"+r+"</a></li>"});t.html(l);t.listview("refresh");t.trigger("updatelayout")})}else if(n&&n.length==0){O();$("#autocomplete1div").show();$("#autocomplete2div").show();$("#cerca0").html("")}});$.ajax({type:"GET",url:"query.xml",dataType:"xml",success:function(e){s.query=$(e)},error:function(){alert("An error occurred while loading backend queries from XML.");return}});$("#search").on("pageshow",function(e){$("#search div .ui-input-search").each(function(e){$(this).css("font-size","16px");$(this).css("height","40px");$(this).css("border","4px solid #c0c0c0")});$("#search .ui-input-search").find("input").each(function(e){$(this).css("font-size","16px");$(this).css("height","100%");$(this).css("color","darkBLue")});$("#search .ui-input-clear").on("click",function(e){console.log("clear invoked...");for(var a=0;a<H.length;a++){H[a]=""}$("#cerca0").html("");$("#menuforma").hide();O();$("#autocomplete1div").show();$("#autocomplete2div").show();$("#menucerca").show()})});$(document).ajaxStart(function(){$("html, body").animate({scrollTop:0},400);$("#popupWait").popup("open",{allowSamePageTransition:true,transition:"pop"})}).ajaxStop(function(){$("html, body").animate({scrollTop:0},400);$("#popupWait").popup("close")});$(document).keydown(function(e){var a=false;var t=e.keyCode?e.keyCode:e.which;if(t=="8"){console.log(" **** backspace pressed");var r=e.srcElement||e.target;if(r.tagName.toUpperCase()==="INPUT"&&(r.type.toUpperCase()==="TEXT"||r.type.toUpperCase()==="PASSWORD"||r.type.toUpperCase()==="FILE"||r.type.toUpperCase()==="SEARCH"||r.type.toUpperCase()==="EMAIL"||r.type.toUpperCase()==="NUMBER"||r.type.toUpperCase()==="DATE")||r.tagName.toUpperCase()==="TEXTAREA"){a=r.readOnly||r.disabled}else{a=true}}else if(t=="9"){console.log(" **** tab pressed")}else if(t=="13"){console.log(" **** carriage return pressed")}if(a){e.preventDefault()}});$("#search").on("swiperight",function(){goback()})}function goback(){if($("#cerca0").html().length==0)return;for(var e=0;e<H.length;e++){H[e]=""}setTimeout(function(){$("#menuforma").hide();$("#menucerca").hide();$.mobile.changePage("#search",{reverse:true,allowSamePageTransition:true,transition:"slide"});$("#cerca0").html("");O();$("#autocomplete1div").show();$("#autocomplete2div").show();$("#menucerca").slideToggle("slow",function(){})},200)}function z(){$("html, body").animate({scrollTop:0},400)}function k(){$("html, body").animate({scrollTop:320},400)}var app={initialize:function(){this.bindEvents();if(typeof cordova=="undefined"){this.onDeviceReady()}},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,false)},onDeviceReady:function(){document.addEventListener("hidekeyboard",z,false);document.addEventListener("showkeyboard",k,false);app.receivedEvent("deviceready");var e=document.getElementById("home1");var a=e.querySelector(".listening");var t=e.querySelector(".received");a.setAttribute("style","display:none;");t.setAttribute("style","display:block;");D()},receivedEvent:function(e){if(console){console.log("Received Event: "+e)}}};function U(e,a){if(!e||e.length==0){console.log("ERRORE: query non specificata in cercaTabellaOrdinataDosaggi()");return}if(!a||a.length==0){console.log("ERRORE: chiave di ricerca non specificata in cercaTabellaOrdinataDosaggi()");return}if(e=="tabellaOrdinataDosaggiPerNF"){a+="%"}$.ajax({url:o,dataType:"json",crossDomain:true,data:{sql:M(e,["text:"+a]),encoding:s.encoding},method:"POST",success:function(e){if(!e||e.length<=0){msgbox("Nessun farmaco autorizzato in<br/>classe A o C","Avviso",200);return}var a=null;var t=null;var r=null;var i=0;var n=false;G=[""];for(var o=0;o<e.length;o++){if(a!=e[o].aic||t!=e[o].id_par){i++;var s=x(e[o].forma);var l=parseInt(e[o].ups);n=true;G[i]=[e[o].aic,0,s,q(e[o]),l,l]}else{if(r==e[o].id_seq&&n){G[i][4]+=parseInt(e[o].ups)}else{n=false;var c=q(e[o]);if(c.length>0){if(G[i][3].length>0){G[i][3]+=" + "}G[i][3]+=c}}}a=e[o].aic;t=e[o].id_par;r=e[o].id_seq}stage=1;setPage(1,null)},error:function(e){console.log("remote error: "+JSON.stringify(e));msgbox("Impossibile collegarsi al backend","Avviso",500)}})}function B(e){var a=e.split(".");var t=a[0];var r=a[1];var i=r.length-1;while(i>=0){if(r[i]!="0")break;i--}if(i<0){return t}else{return t+","+r.substr(0,i+1)}}var F=30;function _(e){if(!isNaN(e)||e.length<F)return e;return e.substr(0,F)+" ..."}function q(e){var a="";try{if(a.length==0&&e.pa_qta!=null){var t=e.pa_qta.replace(/\,/g,".");if(parseFloat(t)>0){a+=B(t);a+=" ";a+=e.pa_um}}if(a.length==0&&e.pa_perc!=null){var r=e.pa_perc.replace(/\,/g,".");if(parseFloat(r)>0){a+=B(r);a+=" ";a+="%"}}if(a.length==0&&e.pas_qta!=null){var t=e.pas_qta.replace(/\,/g,".");if(parseFloat(t)>0){a+=B(t);a+=" ";a+=e.pas_um}}if(a.length==0&&e.pas_perc!=null){var r=e.pas_perc.replace(/\,/g,".");if(parseFloat(r)>0){a+=B(r);a+=" ";a+="%"}}}catch(i){console.log("error: "+i+" - getDose() -> from "+JSON.stringify(e))}if(a.charAt(a.length-1)==",")a=a.substr(0,a.length-1);return a}var V=4;var G=[""];var H=["","","","","","",""];var J=null;var K=0;var Q=2;function setPage(e,a){K=e;H[e]=a;if(e>=V){var t="";var r=null;for(var i=1;i<G.length;i++){if(a&&e>1&&a!=G[i][e]){G[i][1]++}if(e>1&&G[i][1]>0)continue;var n=G[i][0];r=G[i][5];switch(Q){case 2:if(t.length>0){t+=","}t+=n;break;case 1:if(t.length==0){t=n}break;case 0:t=n;break}}J=r;w(t);return}else{var o="";var s=[""];var l=0;var c="|";for(var i=1;i<G.length;i++){if(a&&e>1&&a!=G[i][e]){G[i][1]++}if(e>1&&G[i][1]>0)continue;var u=G[i][e+1];if(c.indexOf("|"+u+"|")>=0)continue;c+=u;c+="|";o+='<tr><td align="left">';o+='<a href="javascript: setPage('+(e+1)+", '"+u+"')\" ";o+='class="ui-corner-all ui-shadow ui-overlay-shadow ui-btn" ';o+='style="background: #11389D; color: white; font-weight: bolder; border-radius: 16px !important;">';o+='<span class="ui-btn-inner" style="vertical-align: middle;">';o+='<span class="ui-btn-text" style="font-size: 14px;">'+_(u)+"</span>";o+="</span>";o+="</a>";o+="</td></tr>";s[l++]=u}if(l<2){setPage(e+1,s[0]);return}}var f='<span style="font-size: 12px;">';for(var i=2;i<=e+1;i++){if(i>2)f+=" &gt; ";f+=H[i]}f+="</span><br/>";switch(e){case 1:f+="selezionare la tipologia";break;case 2:f+="selezionare il dosaggio";break;case 3:f+="selezionare unit&agrave; posologiche";break}$("#cerca0").html(f);$("#menucerca").hide();$("#menuforma").hide();$("#menuforma").html(o);var d=0;var h=[""];$("#menuforma tr").each(function(){var e=$(this);h[d++]=e.text()});h=h.sort(function(e,a){try{var t=e.replace(/\,/g,".").split(" ")[0].toLowerCase();var r=a.replace(/\,/g,".").split(" ")[0].toLowerCase();if(!isNaN(t)&&!isNaN(t)){return parseFloat(t)<parseFloat(r)?1:-1}else{t=e;r=a;for(var i=0;i<t.length&&i<r.length;i++){if(t.charCodeAt(i)<r.charCodeAt(i)){return 1}else if(t.charCodeAt(i)>r.charCodeAt(i)){return-1}}return t.length<r.length?1:-1}}catch(n){console.log("sort error => "+n)}return 0});for(var g=0;g<h.length;g++){$("#menuforma tr").each(function(){var e=$(this);if(e.text()!=h[g])return;e.insertBefore(e.parent().find("tr:first-child"))})}$("#menuforma").slideToggle("slow",function(){});$.mobile.changePage("#search",{allowSamePageTransition:true,transition:"slide"})}
